/*! sink.min.js build:0.0.0, production. Copyright(c) 2013 Eric Zhang, Michelle Bu, Rolland Wu MIT Licensed */(function(e){function n(e,n,r){function f(e){var o=Object.keys(e);for(var a=0,f=o.length;a<f;a++){var l=o[a];i[l]=t.proxify(e[l],l,{metadata:n,nested:s})}r(u)}function l(e){for(var t=0,n=e.length;t<n;t++){var r=e[t];r[0]=r[0].split(".");var i=r[0].pop(),o=r[0].join(".");s[o][i]=r[1]}}function c(e){for(var t=0,n=e.length;t<n;t++){var r=e[t],i=r;r=r.split(".");var o=r.pop(),u=r.join(".");delete s[u][o],delete s[i]}}typeof n=="function"&&(r=n,n={}),n=t.extend({port:"8080",host:"localhost",collision:function(){},version:1,debug:!1},n),t.debug=n.debug;var i={},s={};s[""]=i;var o=n.host;o+=n.port?":"+n.port:"";var u=Proxy.create(t.getChromeProxyFunctions(i,n,"",s)),a=new WebSocket("ws://"+o+"?room="+e);n.socket=a,a.onmessage=function(e){var r=JSON.parse(e.data);t.log("Received message:",r);var i=r[0],s=r[1],o=r[2];i==="init"?f(s):i==="update"||i==="collision"?(l(s),i==="collision"&&n.collision(new Error("You tried to update the sink at the same time as someone else!"))):i==="delete"?c(s):i==="success"&&(o=r[1]),n.version=o}}var t={extend:function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);return e},getChromeProxyFunctions:function(e,n,r,i){function u(){s.length!==0&&(n.socket.send(JSON.stringify(["update",s,n.force?undefined:n.version])),s=[]),o.length!==0&&(n.socket.send(JSON.stringify(["delete",o,n.force?undefined:n.version])),o=[])}t.log("Init proxy functions",n,r),r!==""&&(r+=".");var s=[],o=[];return{get:function(t,n){return e[n]},set:function(o,a,f){if(e[a]===f)return;if(typeof f=="function")return;var l=n.socket;s.push([r+a,f]),t.setZeroTimeout(u),typeof f=="object"&&(f=t.proxify(f,r+a,{metadata:n,nested:i})),e[a]=f},getOwnPropertyDescriptor:function(t){var n=Object.getOwnPropertyDescriptor(e,t);return n!==undefined&&(n.configurable=!0),n},getPropertyDescriptor:function(t){var n=Object.getOwnPropertyDescriptor(e,t);return n!==undefined&&(n.configurable=!0),n},getOwnPropertyNames:function(){return Object.getOwnPropertyNames(e)},getPropertyNames:function(t){return Object.keys(e)},defineProperty:function(t,n){Object.defineProperty(e,t,n)},"delete":function(n){return o.push(r+n),t.setZeroTimeout(u),delete i[r+"."+n],delete e[n]},enumerate:function(){var t=[];for(var n in e)t.push(n);return t},fix:function(){if(Object.isFrozen(e)){var t={},n=Object.getOwnPropertyNames(e);for(var r=0,i=n.length;r<i;r+=1){var s=n[r];t[s]=Object.getOwnPropertyDescriptor(e,s)}return t}return undefined}}},proxify:function(e,n,r){if(typeof e!="object"||!e)return e;var i=t.isArray(e),s={},o=Object.prototype;i&&(s=[],o=Array.prototype);var u=Proxy.create(t.getChromeProxyFunctions(s,r.metadata,n,r.nested),o);r.nested[n]=s;if(i)for(var a=0,f=e.length;a<f;a+=1)s[a]=t.proxify(e[a],n+"."+a,r);else{var l=Object.keys(e);for(var a=0,f=l.length;a<f;a+=1){var c=l[a];s[c]=t.proxify(e[c],n+"."+c,r)}}return u},isArray:function(e){return Object.prototype.toString.call(e)==="[object Array]"||e.constructor===Array},log:function(){if(t.debug){var e=!1,n=Array.prototype.slice.call(arguments);n.unshift("SINK: ");for(var r=0,i=n.length;r<i;r++)n[r]instanceof Error&&(n[r]="("+n[r].name+") "+n[r].message,e=!0);e?console.error.apply(console,n):console.log.apply(console,n)}},setZeroTimeout:function(e){function r(r){t.push(r),e.postMessage(n,"*")}function i(r){r.source==e&&r.data==n&&(r.stopPropagation&&r.stopPropagation(),t.length&&t.shift()())}var t=[],n="zero-timeout-message";return e.addEventListener?e.addEventListener("message",i,!0):e.attachEvent&&e.attachEvent("onmessage",i),r}(this)};e.sink=n})(this)