/*! sink.min.js build:0.0.0, production. Copyright(c) 2013 Eric Zhang, Michelle Bu, Rolland Wu MIT Licensed */(function(e){function n(e){this.obj={},this.nested={},this.nested[""]=this.obj,this.options=e,this.sink=Proxy.create(t.getChromeProxyFunctions(this.obj,e,"",this.nested))}function r(e,r,i){function u(){try{var n=new WebSocket("ws://"+o+"?room="+e)}catch(u){i(null,new Error("Could not open Websocket connection"));return}r.socket=n,n.onmessage=function(e){var n=JSON.parse(e.data);t.log("Received message:",n);var o=n[0],u=n[1],a=n[2];o==="init"?(s.initObject(u),i(s.sink)):o==="update"||o==="collision"?(s.updateObject(u),o==="collision"&&r.collision(new Error("You tried to update the sink at the same time as someone else!"))):o==="delete"?s.deleteProperties(u):o==="success"&&(a=n[1]),r.version=a}}typeof r=="function"&&(i=r,r={}),r=t.extend({port:"8080",host:"localhost",collision:function(){},version:1,debug:!1},r),t.debug=r.debug;var s,o=r.host;o+=r.port?":"+r.port:"",Proxy&&Proxy.create?(t.log("This is Chrome."),s=new n(r)):Proxy&&t.log("This is a direct proxy browser."),s?(t.log("Starting Websocket connection."),t.setZeroTimeout(u)):i(null,new Error("Your browser is not supported"))}var t={extend:function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);return e},getChromeProxyFunctions:function(e,n,r,i){function u(){s.length!==0&&(n.socket.send(JSON.stringify(["update",s,n.force?undefined:n.version])),s=[]),o.length!==0&&(n.socket.send(JSON.stringify(["delete",o,n.force?undefined:n.version])),o=[])}t.log("Init proxy functions",n,r),r!==""&&(r+=".");var s=[],o=[];return{get:function(t,n){return e[n]},set:function(o,a,f){if(e[a]===f||typeof f=="function")return;s.push([r+a,f]),t.setZeroTimeout(u),f=t.proxify(f,r+a,{metadata:n,nested:i}),e[a]=f},getOwnPropertyDescriptor:function(t){var n=Object.getOwnPropertyDescriptor(e,t);return n!==undefined&&(n.configurable=!0),n},getPropertyDescriptor:function(t){var n=Object.getOwnPropertyDescriptor(e,t);return n!==undefined&&(n.configurable=!0),n},getOwnPropertyNames:function(){return Object.getOwnPropertyNames(e)},getPropertyNames:function(t){return Object.keys(e)},defineProperty:function(t,n){Object.defineProperty(e,t,n)},"delete":function(n){return o.push(r+n),t.setZeroTimeout(u),delete i[r+"."+n],delete e[n]},enumerate:function(){var t=[];for(var n in e)t.push(n);return t},fix:function(){if(Object.isFrozen(e)){var t={},n=Object.getOwnPropertyNames(e);for(var r=0,i=n.length;r<i;r+=1){var s=n[r];t[s]=Object.getOwnPropertyDescriptor(e,s)}return t}return undefined}}},proxify:function(e,n,r){if(typeof e!="object"||!e)return e;var i=t.isArray(e),s={},o=Object.prototype;i&&(s=[],o=Array.prototype);var u=Proxy.create(t.getChromeProxyFunctions(s,r.metadata,n,r.nested),o);r.nested[n]=s;if(i)for(var a=0,f=e.length;a<f;a+=1)s[a]=t.proxify(e[a],n+"."+a,r);else{var l=Object.keys(e);for(var a=0,f=l.length;a<f;a+=1){var c=l[a];s[c]=t.proxify(e[c],n+"."+c,r)}}return u},isArray:function(e){return Object.prototype.toString.call(e)==="[object Array]"||e.constructor===Array},log:function(){if(t.debug){var e=!1,n=Array.prototype.slice.call(arguments);n.unshift("SINK: ");for(var r=0,i=n.length;r<i;r++)n[r]instanceof Error&&(n[r]="("+n[r].name+") "+n[r].message,e=!0);e?console.error.apply(console,n):console.log.apply(console,n)}},setZeroTimeout:function(e){function r(r){t.push(r),e.postMessage(n,"*")}function i(r){r.source==e&&r.data==n&&(r.stopPropagation&&r.stopPropagation(),t.length&&t.shift()())}var t=[],n="zero-timeout-message";return e.addEventListener?e.addEventListener("message",i,!0):e.attachEvent&&e.attachEvent("onmessage",i),r}(this)};n.prototype.initObject=function(e){var n=Object.keys(e);for(var r=0,i=n.length;r<i;r++){var s=n[r];this.obj[s]=t.proxify(e[s],s,{metadata:this.options,nested:this.nested})}},n.prototype.updateObject=function(e){for(var n=0,r=e.length;n<r;n++){var i=e[n];i[0]=i[0].split(".");var s=i[0].pop(),o=i[0].join(".");this.nested[o][s]=t.proxify(i[1],o+"."+s,{metadata:this.options,nested:this.nested})}},n.prototype.deleteProperties=function(e){for(var t=0,n=e.length;t<n;t++){var r=e[t],i=r;r=r.split(".");var s=r.pop(),o=r.join(".");delete this.nested[o][s],delete this.nested[i]}},e.sink=r})(this)