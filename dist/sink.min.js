/*! sink.min.js build:0.0.0, production. Copyright(c) 2013 Eric Zhang, Michelle Bu, Rolland Wu MIT Licensed */(function(e){function t(e,t,n){function a(e){var o=Object.keys(e);for(var u=0,a=o.length;u<a;u++){var f=o[u];r[f]=util.proxify(e[f],f,{metadata:t,nested:i})}n(s)}function f(e){for(var t=0,n=e.length;t<n;t++){var r=e[t];r[0]=r[0].split(".");var s=r[0].pop(),o=r[0].join(".");i[o][s]=r[1]}}function l(e){for(var t=0,n=e.length;t<n;t++){var r=e[t],s=r;r=r.split(".");var o=r.pop(),u=r.join(".");delete i[u][o],delete i[s]}}typeof t=="function"&&(n=t,t={}),util.debug=t.debug;var r={},i={};i[""]=r,t.version=1;var s=Proxy.create(util.getChromeProxyFunctions(r,t,"",i)),o=new WebSocket("ws://localhost:8080?room="+e);t.socket=o;var u={};o.onmessage=function(e){var n=JSON.parse(e.data);util.log("Received message:",n);var r=n[0],i=n[1],s=n[2];r==="init"?a(i):r==="update"||r==="collision"?(f(i),r==="collision"&&t.collision&&t.collision(new Error("You tried to update the sink at the same time as someone else!"))):r==="delete"?l(i):r==="success"&&(s=n[1]),t.version=s}}util={getChromeProxyFunctions:function(e,t,n,r){function o(){i.length!==0&&(t.socket.send(JSON.stringify(["update",i,t.force?undefined:t.version])),i=[]),s.length!==0&&(t.socket.send(JSON.stringify(["delete",s,t.force?undefined:t.version])),s=[])}util.log("Init proxy functions",t,n),n!==""&&(n+=".");var i=[],s=[];return{get:function(t,n){return e[n]},set:function(s,u,a){if(e[u]===a)return;var f=t.socket;i.push([n+u,a]),util.setZeroTimeout(o),typeof a=="object"&&(a=util.proxify(a,n+u,{metadata:t,nested:r})),e[u]=a},getOwnPropertyDescriptor:function(t){var n=Object.getOwnPropertyDescriptor(e,t);return n!==undefined&&(n.configurable=!0),n},getPropertyDescriptor:function(t){var n=Object.getOwnPropertyDescriptor(e,t);return n!==undefined&&(n.configurable=!0),n},getOwnPropertyNames:function(){return Object.getOwnPropertyNames(e)},getPropertyNames:function(t){return Object.keys(e)},defineProperty:function(t,n){Object.defineProperty(e,t,n)},"delete":function(t){return s.push(n+t),util.setZeroTimeout(o),delete r[n+"."+t],delete e[t]},enumerate:function(){var t=[];for(var n in e)t.push(n);return t},fix:function(){if(Object.isFrozen(e)){var t={},n=Object.getOwnPropertyNames(e);for(var r=0,i=n.length;r<i;r+=1){var s=n[r];t[s]=Object.getOwnPropertyDescriptor(e,s)}return t}return undefined}}},proxify:function(e,t,n){if(typeof e!="object"||!e)return e;var r=util.isArray(e),i={},s=Object.prototype;r&&(i=[],s=Array.prototype);var o=Proxy.create(util.getChromeProxyFunctions(i,n.metadata,t,n.nested),s);n.nested[t]=i;if(r)for(var u=0,a=e.length;u<a;u+=1)i[u]=util.proxify(e[u],t+"."+u,n);else{var f=Object.keys(e);for(var u=0,a=f.length;u<a;u+=1){var l=f[u];i[l]=util.proxify(e[l],t+"."+l,n)}}return o},isArray:function(e){return Object.prototype.toString.call(e)==="[object Array]"||e.constructor===Array},log:function(){if(util.debug){var e=!1,t=Array.prototype.slice.call(arguments);t.unshift("SINK: ");for(var n=0,r=t.length;n<r;n++)t[n]instanceof Error&&(t[n]="("+t[n].name+") "+t[n].message,e=!0);e?console.error.apply(console,t):console.log.apply(console,t)}},setZeroTimeout:function(e){function r(r){t.push(r),e.postMessage(n,"*")}function i(r){r.source==e&&r.data==n&&(r.stopPropagation&&r.stopPropagation(),t.length&&t.shift()())}var t=[],n="zero-timeout-message";return e.addEventListener?e.addEventListener("message",i,!0):e.attachEvent&&e.attachEvent("onmessage",i),r}(this)},e.sink=t})(this)